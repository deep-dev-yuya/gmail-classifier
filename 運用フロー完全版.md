# Gmail分類システム 運用フロー完全版

## 🎯 問題の解決

**課題**: n8nが書き込むCSVファイルとExcelのラベル付けファイルが別々で同期されない

**解決**: 自動同期システム + 統合ワークフロー管理

---

## 🔄 完全統合フロー

### **ステップ1: n8n自動書き込み**
```
Gmail受信 → n8n処理 → CSV自動追加
                       ↓
           retraining_candidates_enhanced.csv
```

### **ステップ2: CSV→Excel同期**
```bash
# 新しいデータをExcelに同期（ドロップダウン付き）
python3 scripts/sync_csv_excel.py --csv-to-excel
```

**処理内容**:
- ✅ CSVの新レコードをExcelに追加
- ✅ 既存ラベルを保持
- ✅ ドロップダウン機能を再設定
- ✅ 自動バックアップ作成

### **ステップ3: Excelでラベル付け**
```bash
# Excelファイルを開いてラベル付け
open /Users/hasegawayuya/Projects/dev-projects/gmail-classifier/n8n/retraining_candidates_enhanced.xlsx
```

**操作内容**:
- ✅ groundTruth列（オレンジ色）でドロップダウン選択
- ✅ 4つのラベルから選択（支払い関係、重要、プロモーション、仕事・学習）
- ✅ 修正理由を記録（任意）

### **ステップ4: Excel→CSV同期**
```bash
# ラベル付け結果をCSVに反映
python3 scripts/sync_csv_excel.py --excel-to-csv
```

**処理内容**:
- ✅ Excelの正解ラベルをCSVに転写
- ✅ モデル学習用データを準備
- ✅ 学習履歴を記録

### **ステップ5: モデル自動更新**
```bash
# 正解ラベル付きデータで自動学習
python3 scripts/update_groundtruth_model.py
```

### **ステップ6: API反映**
```bash
# Flask APIでモデルリロード
curl -X POST http://localhost:5002/api/model/reload
```

---

## 🚀 ワンコマンド実行

### **完全自動化**
```bash
# 全工程を自動実行
python3 scripts/automated_workflow.py --auto
```

### **対話型管理**
```bash
# 対話型で操作選択
python3 scripts/automated_workflow.py
```

**対話メニュー**:
```
1. ファイル変更チェック & 自動同期
2. CSV → Excel 同期
3. Excel → CSV 同期
4. モデル更新実行
5. API モデルリロード
6. ワークフロー状態確認
7. 完全自動実行
```

---

## 📊 自動監視機能

### **ファイル変更検出**
- CSVファイルの更新を自動検出
- Excelファイルの変更を自動検出
- タイムスタンプ比較で同期方向を判定

### **データ品質チェック**
- 正解ラベル付きデータ数の確認
- 学習可能データ数の検証
- 進捗率の自動計算

### **状態レポート**
```
📊 Gmail分類ワークフロー状態
================================================
📝 総レコード数: 15
✅ ラベル付き: 10
⏳ 未ラベル: 5
📈 進捗率: 66.7%

🤖 利用可能モデル:
   ✅ 教師あり学習モデル
   ✅ 実運用改良モデル
   ✅ バランス調整モデル
```

---

## 🔧 技術的特徴

### **同期システム**
- **双方向同期**: CSV ⇄ Excel
- **データ保持**: 既存ラベルを完全保持
- **自動バックアップ**: 変更前のファイルを自動保存
- **重複防止**: messageIDベースで重複チェック

### **Excel強化機能**
- **ドロップダウン検証**: 正確なラベル選択を保証
- **視覚的強調**: groundTruth列をオレンジで強調
- **自動フォーマット**: ヘッダースタイル、列幅調整
- **エラー防止**: 無効データの入力を拒否

### **統合管理**
- **ワンコマンド実行**: 全工程を自動化
- **進捗追跡**: リアルタイム状態監視
- **エラーハンドリング**: 各段階でのエラー検出・報告
- **ログ記録**: 操作履歴の自動記録

---

## 📅 推奨運用スケジュール

### **日次（平日）**
```bash
# 朝: 新データをExcelに同期
python3 scripts/sync_csv_excel.py --csv-to-excel

# 夕方: ラベル付け作業
open retraining_candidates_enhanced.xlsx

# 夜: ラベルをCSVに反映
python3 scripts/sync_csv_excel.py --excel-to-csv
```

### **週次（金曜日）**
```bash
# モデル更新 & API反映
python3 scripts/automated_workflow.py --auto
```

### **月次**
```bash
# 総合状態確認
python3 scripts/automated_workflow.py
# メニューから「6. ワークフロー状態確認」を選択
```

---

## 🎉 達成された効果

### **Before（問題あり）**
- ❌ ファイルが分離している
- ❌ 手動同期が必要
- ❌ ラベル付けが非効率
- ❌ モデル更新が複雑

### **After（完全統合）**
- ✅ **完全自動同期**
- ✅ **ワンコマンド実行**
- ✅ **ドロップダウン効率化**
- ✅ **統合ワークフロー管理**
- ✅ **リアルタイム進捗監視**
- ✅ **エラー自動検出**

---

## 🛡️ 安全性・信頼性

### **データ保護**
- 自動バックアップ作成
- 操作前のファイル保存
- エラー時の自動復旧手順

### **品質保証**
- データ検証機能
- 重複チェック
- 整合性確認

### **運用監視**
- 処理状況のリアルタイム表示
- エラーの詳細レポート
- 学習データ品質チェック

---

*この統合システムにより、Gmail分類の正解ラベル付けから機械学習モデル更新まで、完全に自動化された効率的な運用が実現されました。*

*最終更新: 2025-07-24*
*作成者: Claude Code Assistant*