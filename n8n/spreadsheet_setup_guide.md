# Gmail分類ワークフロー用 Google Sheets設定ガイド

## 🎯 目的
n8nワークフロー「Gmail自動ラベル分類」で使用するGoogle Sheetsスプレッドシートの設定方法

## 📋 スプレッドシート構成

### 必要なシート一覧
1. **ログ** - 全メール処理履歴
2. **再学習候補** - 信頼度不足メールの記録
3. **ダッシュボード** - 統計情報とサマリー

## 🔧 設定手順

### 1. Google Sheetsスプレッドシートの作成

1. Google Sheetsで新しいスプレッドシートを作成
2. スプレッドシートに名前を付ける（例：「Gmail分類ログ」）
3. スプレッドシートのIDをコピー（URLの `/d/` と `/edit` の間の文字列）

### 2. シートの設定

#### A. 「ログ」シートの設定

**シート名**: `ログ`

**カラム構成（A1:H1）**:
| 列 | カラム名 | データ型 | 説明 |
|---|---|---|---|
| A | timestamp | DateTime | 処理日時 |
| B | messageId | Text | GmailメッセージID |
| C | subject | Text | メール件名 |
| D | classification | Text | AI分類結果 |
| E | confidence | Number | 信頼度（0-1） |
| F | gmailLabel | Text | 付与されたGmailラベル |
| G | enrichedContext | Text | 文脈補完結果 |
| H | status | Text | 処理状況 |

**フォーマット設定**:
- A列: 日付時刻形式（yyyy-MM-dd HH:mm:ss）
- E列: 小数点以下3桁表示
- H列: 条件付き書式（「完了」=緑、「要確認」=オレンジ）

#### B. 「再学習候補」シートの設定

**シート名**: `再学習候補`

**カラム構成（A1:F1）**:
| 列 | カラム名 | データ型 | 説明 |
|---|---|---|---|
| A | timestamp | DateTime | 処理日時 |
| B | messageId | Text | GmailメッセージID |
| C | subject | Text | メール件名 |
| D | predictedClass | Text | 予測分類結果 |
| E | confidence | Number | 信頼度（0-1） |
| F | reason | Text | 要確認理由 |

**フォーマット設定**:
- A列: 日付時刻形式（yyyy-MM-dd HH:mm:ss）
- E列: 小数点以下3桁表示
- 全行: 背景色薄いオレンジ（要確認を表現）

#### C. 「ダッシュボード」シートの設定

**シート名**: `ダッシュボード`

**構成**:
- 統計情報表示
- グラフとチャート
- 分類精度監視

### 3. n8nワークフローでの設定

#### ワークフローJSONファイルの編集

```json
{
  "parameters": {
    "sheetId": "YOUR_GOOGLE_SHEET_ID",
    "range": "ログ!A:H"
  }
}
```

**変更箇所**:
- `YOUR_GOOGLE_SHEET_ID` → 実際のスプレッドシートID
- 必要に応じてシート名を変更

## 📊 サンプルデータ

### ログシートサンプル
```
timestamp,messageId,subject,classification,confidence,gmailLabel,enrichedContext,status
2025-07-16T10:30:00Z,18f2a1b2c3d4e5f6,PayPay利用完了のお知らせ,支払い関係,0.832,AI-Payment,"高優先度のメール、PayPay関連、(強度: 2)、請求・料金に関する通知、処理完了済み、金額: 1250円、major_payment: PayPay、store_service: セブンイレブン、アクションが必要",完了
```

### 再学習候補シートサンプル
```
timestamp,messageId,subject,predictedClass,confidence,reason
2025-07-16T10:34:00Z,5ch6e8f9a0b1c2d3,件名が不明確なメール,重要,0.423,信頼度不足
```

## 🎨 推奨フォーマット設定

### 1. 条件付き書式

#### ログシートの信頼度カラム（E列）
- 0.8以上: 緑色背景
- 0.5-0.8: 黄色背景
- 0.5未満: 赤色背景

#### ログシートのステータスカラム（H列）
- 「完了」: 緑色背景
- 「要確認」: オレンジ色背景

### 2. データ検証

#### 分類カラム（D列）
- リスト検証: 支払い関係, 重要, プロモーション, 仕事・学習

#### Gmailラベルカラム（F列）
- リスト検証: AI-Payment, AI-Important, AI-Promotion, AI-Work-Study, AI-NeedsReview

## 📈 ダッシュボードの作成

### 1. 基本統計

#### 処理件数サマリー
```
=COUNTA(ログ!A:A)-1  // 総処理件数
=COUNTIF(ログ!H:H,"完了")  // 完了件数
=COUNTIF(ログ!H:H,"要確認")  // 要確認件数
```

#### 分類精度
```
=COUNTIF(ログ!H:H,"完了")/COUNTA(ログ!A:A)-1  // 完了率
=AVERAGE(ログ!E:E)  // 平均信頼度
```

### 2. 分類別統計

#### 分類別件数
```
=COUNTIF(ログ!D:D,"支払い関係")  // 支払い関係件数
=COUNTIF(ログ!D:D,"重要")  // 重要件数
=COUNTIF(ログ!D:D,"プロモーション")  // プロモーション件数
=COUNTIF(ログ!D:D,"仕事・学習")  // 仕事・学習件数
```

### 3. グラフ作成

#### 分類分布円グラフ
- データ範囲: 分類別件数
- グラフタイプ: 円グラフ
- 色分け: 各分類に対応した色

#### 信頼度分布ヒストグラム
- データ範囲: 信頼度カラム（E列）
- グラフタイプ: ヒストグラム
- 区間: 0.1刻み

#### 日別処理件数推移
- データ範囲: 日付別集計
- グラフタイプ: 折れ線グラフ

## 🔧 権限設定

### 1. 共有設定
- n8nサービスアカウントに編集権限を付与
- 必要に応じてチームメンバーに閲覧権限を付与

### 2. API設定
- Google Sheets APIの有効化
- サービスアカウントキーの設定
- n8nでの認証設定

## 🚨 注意事項

### 1. データ保護
- 個人情報を含むメール件名の取り扱い注意
- 必要に応じて件名のマスキング処理

### 2. 容量管理
- 大量データ蓄積時の性能考慮
- 定期的なデータアーカイブ

### 3. バックアップ
- 定期的なスプレッドシートのバックアップ
- 重要データの複製保存

## 🔄 運用フロー

### 1. 日次運用
- ダッシュボードでの統計確認
- 要確認メールの手動確認
- 分類精度のモニタリング

### 2. 週次運用
- 再学習候補の分析
- 分類精度の傾向分析
- 必要に応じたモデル調整

### 3. 月次運用
- 月次統計の作成
- 分類精度の月次レポート
- システム改善の検討

## 🛠️ トラブルシューティング

### よくある問題

1. **書き込み権限エラー**
   - 解決: サービスアカウントの権限確認

2. **シート名エラー**
   - 解決: ワークフローのシート名設定確認

3. **データ形式エラー**
   - 解決: カラム形式の確認と修正

4. **容量制限エラー**
   - 解決: 古いデータのアーカイブ

## 📁 提供ファイル

### CSVファイル
- `gmail_log_sheet.csv` - ログシートサンプル
- `retraining_candidates_sheet.csv` - 再学習候補シートサンプル
- `dashboard_sheet.csv` - ダッシュボードシートサンプル

### 設定ファイル
- `spreadsheet_setup_guide.md` - 本設定ガイド
- `gmail_label_workflow.json` - n8nワークフロー定義