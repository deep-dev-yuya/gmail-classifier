# Gmailè‡ªå‹•ãƒ©ãƒ™ãƒ«åˆ†é¡ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ - æ§‹æˆèª¬æ˜

## ğŸ¯ ç›®çš„
Gmailã§å—ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•åˆ†é¡ã—ã€**Gmailè‡ªä½“ã«ãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸**ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

## ğŸ“‹ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹æˆ

### 1. å…¨ä½“ãƒ•ãƒ­ãƒ¼å›³
```
Gmail Trigger
    â†“
Email Preprocessing (HTMLã‚¿ã‚°é™¤å»ãƒ»æ­£è¦åŒ–)
    â†“
Context Enricher (æ–‡è„ˆè£œå®Œãƒ»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡º)
    â†“
AI Classification (Flask APIåˆ†é¡)
    â†“
Label Mapping (åˆ†é¡çµæœâ†’Gmailãƒ©ãƒ™ãƒ«å¤‰æ›)
    â†“
Gmail Add Label (Gmailã«ãƒ©ãƒ™ãƒ«ä»˜ä¸)
    â†“
Classification Switch (åˆ†é¡åˆ¥åˆ†å²)
    â”œâ”€ Google Sheets Log (é€šå¸¸ãƒ­ã‚°)
    â””â”€ Low Confidence Log (è¦ç¢ºèªãƒ­ã‚°)
```

### 2. å„ãƒãƒ¼ãƒ‰è©³ç´°

#### Gmail Trigger
- **æ©Ÿèƒ½**: æ–°ç€ãƒ¡ãƒ¼ãƒ«ã®ç›£è¦–
- **è¨­å®š**: æ¯åˆ†ãƒã‚§ãƒƒã‚¯
- **å‡ºåŠ›**: messageId, subject, textPlain/textHtml

#### Email Preprocessing
- **æ©Ÿèƒ½**: HTMLã‚¿ã‚°é™¤å»ãƒ»ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–
- **é‡è¦**: messageIdã‚’ä¿æŒã—ã¦Gmailãƒ©ãƒ™ãƒ«ä»˜ä¸ã§ä½¿ç”¨
```javascript
return {
  json: {
    ...data,
    subject: data.subject || '',
    body: normalizedBody,
    messageId: data.id,  // Gmail messageId ã‚’ä¿æŒ
    processedAt: new Date().toISOString()
  }
};
```

#### Context Enricher
- **URL**: `http://localhost:5002/api/enrich-context`
- **æ©Ÿèƒ½**: é«˜åº¦æ–‡è„ˆè£œå®Œãƒ»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡º
- **å‡ºåŠ›**: enriched_context, priority_level, paypay_strength

#### AI Classification
- **URL**: `http://localhost:5002/api/classify`
- **æ©Ÿèƒ½**: Pipelineåˆ†é¡ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹åˆ†é¡
- **å‡ºåŠ›**: classification, confidence, context_analysis

#### Label Mapping
- **æ©Ÿèƒ½**: åˆ†é¡çµæœã‚’Gmailãƒ©ãƒ™ãƒ«ã«ãƒãƒƒãƒ”ãƒ³ã‚°
- **ãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°**:
```javascript
const labelMapping = {
  'æ”¯æ‰•ã„é–¢ä¿‚': 'AI-Payment',
  'é‡è¦': 'AI-Important', 
  'ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³': 'AI-Promotion',
  'ä»•äº‹ãƒ»å­¦ç¿’': 'AI-Work-Study'
};
```
- **ä¿¡é ¼åº¦ãƒã‚§ãƒƒã‚¯**: confidence < 0.5 â†’ 'AI-NeedsReview'

#### Gmail Add Label
- **æ“ä½œ**: `addLabels`
- **è¨­å®š**: 
  - messageId: `={{ $json.messageId }}`
  - labelIds: `={{ $json.gmailLabel }}`
  - createLabels: trueï¼ˆãƒ©ãƒ™ãƒ«è‡ªå‹•ä½œæˆï¼‰

#### Classification Switch
- **æ©Ÿèƒ½**: åˆ†é¡çµæœã«ã‚ˆã‚‹åˆ†å²å‡¦ç†
- **æ¡ä»¶**:
  1. æ”¯æ‰•ã„é–¢ä¿‚ â†’ é€šå¸¸ãƒ­ã‚°
  2. é‡è¦ â†’ é€šå¸¸ãƒ­ã‚°
  3. ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ â†’ é€šå¸¸ãƒ­ã‚°
  4. ä»•äº‹ãƒ»å­¦ç¿’ â†’ é€šå¸¸ãƒ­ã‚°
  5. ä¿¡é ¼åº¦ä¸è¶³ â†’ é€šå¸¸ãƒ­ã‚° + è¦ç¢ºèªãƒ­ã‚°

#### Google Sheets Log
- **ã‚·ãƒ¼ãƒˆ**: `ãƒ­ã‚°!A:H`
- **è¨˜éŒ²é …ç›®**:
  - timestamp, messageId, subject
  - classification, confidence, gmailLabel
  - enrichedContext, status

#### Low Confidence Log
- **ã‚·ãƒ¼ãƒˆ**: `å†å­¦ç¿’å€™è£œ!A:F`
- **æ¡ä»¶**: confidence < 0.5
- **è¨˜éŒ²é …ç›®**:
  - timestamp, messageId, subject
  - predictedClass, confidence, reason

## ğŸ”§ è¨­å®šè¦é …

### 1. å¿…é ˆè¨­å®š
- **Gmail API**: modifyæ¨©é™ãŒå¿…è¦
- **Google Sheets ID**: `YOUR_GOOGLE_SHEET_ID`ã‚’å®Ÿéš›ã®IDã«å¤‰æ›´
- **Flask API**: http://localhost:5002ã§ç¨¼åƒ

### 2. Gmailãƒ©ãƒ™ãƒ«ä¸€è¦§
è‡ªå‹•ä½œæˆã•ã‚Œã‚‹ãƒ©ãƒ™ãƒ«:
- `AI-Payment`: æ”¯æ‰•ã„é–¢ä¿‚
- `AI-Important`: é‡è¦
- `AI-Promotion`: ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
- `AI-Work-Study`: ä»•äº‹ãƒ»å­¦ç¿’
- `AI-NeedsReview`: è¦ç¢ºèªï¼ˆä¿¡é ¼åº¦ä¸è¶³ï¼‰
- `AI-Unclassified`: æœªåˆ†é¡

### 3. Google Sheetsã‚·ãƒ¼ãƒˆæ§‹æˆ
#### ãƒ­ã‚°ã‚·ãƒ¼ãƒˆ
| åˆ— | é …ç›® | ä¾‹ |
|---|---|---|
| A | timestamp | 2025-07-16T10:30:00Z |
| B | messageId | 18f2a1b2c3d4e5f6 |
| C | subject | PayPayåˆ©ç”¨å®Œäº†ã®ãŠçŸ¥ã‚‰ã› |
| D | classification | æ”¯æ‰•ã„é–¢ä¿‚ |
| E | confidence | 0.832 |
| F | gmailLabel | AI-Payment |
| G | enrichedContext | é«˜å„ªå…ˆåº¦ã®ãƒ¡ãƒ¼ãƒ«ã€PayPayé–¢é€£... |
| H | status | å®Œäº† |

#### å†å­¦ç¿’å€™è£œã‚·ãƒ¼ãƒˆ
| åˆ— | é …ç›® | ä¾‹ |
|---|---|---|
| A | timestamp | 2025-07-16T10:30:00Z |
| B | messageId | 18f2a1b2c3d4e5f6 |
| C | subject | æ›–æ˜§ãªä»¶å |
| D | predictedClass | é‡è¦ |
| E | confidence | 0.423 |
| F | reason | ä¿¡é ¼åº¦ä¸è¶³ |

## ğŸš€ ä¸»ãªæ”¹å–„ç‚¹

### å¾“æ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰ã®å¤‰æ›´
1. **LINEé€šçŸ¥å‰Šé™¤**: åˆ¥ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§å‡¦ç†æ¸ˆã¿ã®ãŸã‚é™¤å¤–
2. **Gmailãƒ©ãƒ™ãƒ«ä»˜ä¸**: messageIdã‚’ä½¿ç”¨ã—ãŸãƒ©ãƒ™ãƒ«è‡ªå‹•ä»˜ä¸
3. **å…¨åˆ†é¡å¯¾å¿œ**: 4ã¤ã®åˆ†é¡ã™ã¹ã¦ã«å¯¾å¿œã—ãŸSwitchæ¡ä»¶
4. **ä¿¡é ¼åº¦å‡¦ç†**: ä½ä¿¡é ¼åº¦ãƒ¡ãƒ¼ãƒ«ã‚’è¦ç¢ºèªã¨ã—ã¦åˆ¥é€”è¨˜éŒ²
5. **ãƒ©ãƒ™ãƒ«è‡ªå‹•ä½œæˆ**: å­˜åœ¨ã—ãªã„ãƒ©ãƒ™ãƒ«ã¯è‡ªå‹•ä½œæˆ

### æ–°æ©Ÿèƒ½
1. **é«˜åº¦æ–‡è„ˆè£œå®Œ**: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰é«˜åº¦åŒ–å¯¾å¿œ
2. **ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡º**: é‡‘é¡ãƒ»æ—¥ä»˜ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã®æŠ½å‡º
3. **å„ªå…ˆåº¦è¨ˆç®—**: PayPayç‰¹åŒ–ãƒ»ç·Šæ€¥åº¦ã«ã‚ˆã‚‹å„ªå…ˆåº¦åˆ¤å®š
4. **å†å­¦ç¿’æ”¯æ´**: ä¿¡é ¼åº¦ä¸è¶³ãƒ¡ãƒ¼ãƒ«ã®è‡ªå‹•è¨˜éŒ²

## ğŸ“Š é‹ç”¨ãƒ¡ãƒªãƒƒãƒˆ

1. **è‡ªå‹•åˆ†é¡**: æ‰‹å‹•ãƒ©ãƒ™ãƒ«ä»˜ä¸ä½œæ¥­ã®å‰Šæ¸›
2. **ä¸€è²«æ€§**: AIåˆ†é¡ã«ã‚ˆã‚‹å®¢è¦³çš„ãªãƒ©ãƒ™ãƒ«ä»˜ä¸
3. **ãƒˆãƒ¬ãƒ¼ã‚µãƒ“ãƒªãƒ†ã‚£**: å…¨å‡¦ç†å±¥æ­´ã®Google Sheetsè¨˜éŒ²
4. **ç¶™ç¶šæ”¹å–„**: ä½ä¿¡é ¼åº¦ãƒ¡ãƒ¼ãƒ«ã®å†å­¦ç¿’ãƒ‡ãƒ¼ã‚¿è“„ç©
5. **Gmailçµ±åˆ**: æ—¢å­˜ã®Gmailãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¨ã®å®Œå…¨çµ±åˆ

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

1. **ãƒ©ãƒ™ãƒ«ä»˜ä¸å¤±æ•—**
   - Gmail APIæ¨©é™ã‚’ç¢ºèª
   - messageIdãŒæ­£ã—ãæ¸¡ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **åˆ†é¡ç²¾åº¦ãŒä½ã„**
   - å†å­¦ç¿’å€™è£œã‚·ãƒ¼ãƒˆã‹ã‚‰å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
   - Flask APIã®Pipelineãƒ¢ãƒ‡ãƒ«ã‚’å†å­¦ç¿’

3. **Google Sheetsæ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼**
   - ã‚·ãƒ¼ãƒˆIDãŒæ­£ã—ã„ã‹ç¢ºèª
   - æ¨©é™è¨­å®šã‚’ç¢ºèª

4. **Flask APIæ¥ç¶šã‚¨ãƒ©ãƒ¼**
   - http://localhost:5002ã§APIãŒç¨¼åƒã—ã¦ã„ã‚‹ã‹ç¢ºèª
   - /api/classify ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå¿œç­”ã™ã‚‹ã‹ç¢ºèª